let state={zone:WORLD.startingZone,hp:30,maxHp:30,inventory:[],log:[]};const outputEl=document.getElementById('output');const form=document.getElementById('command-form');const inputEl=document.getElementById('command-input');const actionsToolbar=document.getElementById('actions');function log(text){state.log.push(text);outputEl.textContent=state.log.join('\n');outputEl.scrollTop=outputEl.scrollHeight;}function describeZone(){const zone=WORLD.zones[state.zone];log(`\n== ${state.zone} ==\n${zone.description}`);if(zone.npcs.length)log('You see: '+zone.npcs.map(k=>WORLD.npcs[k].name).join(', '));if(Object.keys(zone.exits).length)log('Exits: '+Object.keys(zone.exits).join(', '));}function move(direction){const zone=WORLD.zones[state.zone];if(zone.exits[direction]){state.zone=zone.exits[direction];describeZone();}else{log("You can't go that way.");}}function dropLoot(npcKey){const npc=WORLD.npcs[npcKey];const drops=[];if(npc.loot)drops.push(...npc.loot);if(Math.random()<0.05){const rare=WORLD.rareTable[Math.floor(Math.random()*WORLD.rareTable.length)];drops.push(rare);}drops.forEach(it=>{state.inventory.push(it);log(`You loot ${WORLD.items[it].name}!`);});}function attack(targetName){const zone=WORLD.zones[state.zone];const npcKey=zone.npcs.find(k=>WORLD.npcs[k].name.toLowerCase()===targetName);if(!npcKey){log('There is no such target here.');return;}const npc=WORLD.npcs[npcKey];log(`You attack ${npc.name}!`);npc.hp-=5;if(npc.hp<=0){log(`${npc.name} is defeated!`);dropLoot(npcKey);zone.npcs=zone.npcs.filter(k=>k!==npcKey);}else{state.hp-=npc.attack;log(`${npc.name} hits you for ${npc.attack} damage! (HP ${state.hp}/${state.maxHp})`);if(state.hp<=0){log('You have been slain! Respawning at Qeynos Gates...');state.hp=state.maxHp;state.zone=WORLD.startingZone;describeZone();}}}function showInventory(){if(state.inventory.length===0){log('Your inventory is empty.');}else{log('Inventory:\n'+state.inventory.map(it=>'- '+WORLD.items[it].name).join('\n'));}}function help(){log('Commands: look, go <direction>, attack <target>, inventory, help');}function handleCommand({verb,target}){switch(verb){case'look':describeZone();break;case'go':move(target);break;case'attack':attack(target);break;case'inventory':showInventory();break;case'help':help();break;default:log("Unknown command. Type 'help' for a list of commands.");}}function saveGame(){localStorage.setItem('textquest_save',JSON.stringify(state));}function loadGame(){const saved=localStorage.getItem('textquest_save');if(saved){state=JSON.parse(saved);}}actionsToolbar.addEventListener('click',e=>{if(e.target.tagName==='BUTTON'){const cmd=e.target.getAttribute('data-cmd');log('> '+cmd);handleCommand(parseCommand(cmd));saveGame();inputEl.focus();}});form.addEventListener('submit',e=>{e.preventDefault();const cmd=inputEl.value;if(!cmd.trim())return;log('> '+cmd);handleCommand(parseCommand(cmd));inputEl.value='';saveGame();});window.addEventListener('load',()=>{loadGame();describeZone();});
